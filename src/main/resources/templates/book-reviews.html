<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
    <head>
        <meta charset="UTF-8">
        <meta name="_csrf" th:content="${_csrf.token}" />
        <meta name="_csrf_header" th:content="${_csrf.headerName}" />

        <title>Book Reviews</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- Bootstrap CSS CDN -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

        <style>
            .user-menu {
                position: relative;
                display: inline-block;
            }

            .user-menu-content {
                display: none;
                position: absolute;
                right: 0;
                background-color: #fff;
                min-width: 160px;
                border: 1px solid #ddd;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
                z-index: 1000;
            }

            .user-menu-content.show {
                display: block;
            }

            .user-menu-content button {
                width: 100%;
                padding: 8px 12px;
                border: none;
                background: none;
                text-align: left;
            }

            .user-menu-content button:hover {
                background-color: #f8f9fa;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(-5px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .fade-in {
                animation: fadeIn 0.6s ease-in-out;
            }

        </style>
    </head>
    <body class="bg-light">

        <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom mb-4 px-3">
            <a class="navbar-brand" href="#">ðŸ“š BookZone</a>
            <div class="ms-auto">
                <div class="user-menu" th:if="${loggedInUserName != null}">
                    <button class="btn btn-outline-secondary" id="userToggleBtn">
                        Hello, <span th:text="${loggedInUserName}">User</span> â–¼
                    </button>
                    <div class="user-menu-content" id="userMenu">
                        <form th:action="@{/logout}" method="post">
                            <button type="submit" class="text-danger">Logout</button>
                        </form>
                    </div>
                </div>

                <div th:if="${loggedInUserName == null}">
                    <a id="loginBtn" class="btn btn-outline-primary me-2"
                       th:href="@{/login}">Login</a>
                    <!--            <a class="btn btn-primary" href="/register">Sign Up</a>&ndash;&gt;-->
                </div>


            </div>
        </nav>



        <div class="container mt-5">
            <h2 th:text="${bookTitle}"></h2>

            <hr>

            <!-- Reviews -->
            <div class="mb-4">
                <h4>Reviews</h4>
                <div class="list-group" id="reviewList">
                    <!-- Dynamically inserted reviews go here -->
                    <div class="list-group">
                        <div th:each="review : ${reviews}" class="list-group-item list-group-item-action">
                            <p th:text="${review.comment}" class="mb-1"></p>
                            <small th:text="'Posted by ' + ${review.reviewer.fullName} + ' on ' + ${review.createdAtFormatted}"></small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add New Review -->
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Add a Review</h5>

                    <form id="reviewForm" th:data-bookId="${bookId}">
                        <!-- Comment -->
                        <div class="mb-3">
                            <label for="comment" class="form-label">Comment</label>
                            <textarea id="comment" name="comment" class="form-control" rows="3" required></textarea>
                        </div>

                        <!-- Submit -->

                        <input type="hidden" name="loggedInUserFullName" th:value="${loggedInUserName}" >
                        <button type="submit" class="btn btn-primary">Post Review</button>
                        <div id="youMustLoginDiv" class="alert alert-danger mt-3" style="display: none">
                            You must log in to post a comment.
                        </div>
                    </form>
                </div>
            </div>
        </div>

    <!-- JavaScript -->
        <script>

            document.addEventListener("DOMContentLoaded", () => {
                const form = document.getElementById("reviewForm");
                const alertDiv = document.getElementById("youMustLoginDiv");
                const userFullNameInput = form.querySelector("input[name='loggedInUserFullName']");

                const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

                if (!form) return;


                form.addEventListener("submit", function (e) {
                    e.preventDefault();

                    const userFullName = userFullNameInput.value.trim();

                    // User not logged in
                    if (!userFullName) {
                        e.preventDefault(); // Stop form submission
                        alertDiv.style.display = "block"; // Show alert

                        // Hide after 5 seconds
                        setTimeout(() => {
                            alertDiv.style.display = "none";
                        }, 5000);

                        return;
                    }

                    const bookId = form.getAttribute("data-bookId");
                    const formData = new FormData(form);

                    fetch(`/books/${bookId}/reviews`, {
                        method: "POST",
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            [header]: token
                        },
                        body: formData
                    })
                        .then(response => {
                            if (response.redirected) {
                                window.location.href = response.url;
                                return;
                            }
                            return response.text();
                        })
                        .then(html => {
                            if (html) {
                                const reviewList = document.getElementById("reviewList");
                                const tempDiv = document.createElement("div");
                                tempDiv.innerHTML = html.trim();
                                const newReview = tempDiv.firstChild;

                                newReview.classList.add("fade-in");
                                reviewList.querySelector(".list-group").prepend(newReview);
                                form.reset();
                            }
                        })
                        .catch(err => alert("Error: " + err));
                });
            });


            document.addEventListener("DOMContentLoaded", function () {
                const loginBtn = document.getElementById("loginBtn");
                if (loginBtn) {
                    loginBtn.addEventListener("click", function (e) {
                        e.preventDefault();
                        const currentUrl = window.location.pathname + window.location.search;
                        window.location.href = `/login?returnTo=${encodeURIComponent(currentUrl)}`;
                    });
                }
            });
            document.addEventListener("DOMContentLoaded", function () {
                const toggleBtn = document.getElementById('userToggleBtn');
                const userMenu = document.getElementById('userMenu');

                if(toggleBtn) {
                    toggleBtn.addEventListener('click', function (e) {
                        e.stopPropagation();
                        userMenu.classList.toggle('show');
                    });
                }

                // Hide dropdown when clicking outside
                if(userMenu) {
                    window.addEventListener('click', function () {
                        if (userMenu.classList.contains('show')) {
                            userMenu.classList.remove('show');
                        }
                    });
                }

            });


            document.addEventListener("DOMContentLoaded", function () {
                const form = document.getElementById("reviewForm");
                const alertDiv = document.getElementById("youMustLoginDiv");
                const userFullNameInput = form.querySelector("input[name='loggedInUserFullName']");

                form.addEventListener("submit", function (e) {
                    const userFullName = userFullNameInput.value.trim();

                    if (!userFullName) {
                        e.preventDefault(); // Stop form submission
                        alertDiv.style.display = "block"; // Show alert

                        // Hide after 5 seconds
                        setTimeout(() => {
                            alertDiv.style.display = "none";
                        }, 5000);
                    } else {
                        alertDiv.style.display = "none"; // Hide if user is logged in
                    }
                });
            });


        </script>
    </body>
</html>
