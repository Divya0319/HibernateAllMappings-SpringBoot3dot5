<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Book Reviews</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-5">
    <h2 th:text="${bookTitle}"></h2>

    <hr>

    <!-- Reviews -->
    <div class="mb-4">
        <h4>Reviews</h4>
        <div class="list-group" id="reviewList">
            <!-- Dynamically inserted reviews go here -->
            <div class="list-group">
                <div th:each="review : ${reviews}" class="list-group-item list-group-item-action">
                    <p th:text="${review.comment}" class="mb-1"></p>
                    <small th:text="'Posted by ' + ${review.reviewer.fullName} + ' on ' + ${review.createdAtFormatted}"></small>
                </div>
            </div>
        </div>
    </div>

    <!-- Add New Review -->
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Add a Review</h5>

            <form id="reviewForm">
                <!-- Comment -->
                <div class="mb-3">
                    <label for="comment" class="form-label">Comment</label>
                    <textarea id="comment" name="comment" class="form-control" rows="3" required></textarea>
                </div>

                <!-- Login Card -->
                <div id="loginCard" class="card border-warning bg-light-subtle p-3 mb-3" style="display: none;">
                    <div class="mb-2 text-warning-emphasis fw-semibold">ðŸ”’ Sign in to post your comment</div>
                    <div class="row g-2">
                        <div class="col-md-6">
                            <input type="text" id="username" class="form-control" placeholder="Username" />
                        </div>
                        <div class="col-md-6">
                            <input type="password" id="password" class="form-control" placeholder="Password" />
                        </div>
                    </div>
                    <div class="mt-3">
                        <button type="button" id="signInBtn" class="btn btn-sm btn-success">Sign In & Post</button>
                    </div>
                </div>

                <!-- Submit -->
                <button type="submit" class="btn btn-primary">Post Review</button>
            </form>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
    const form = document.getElementById("reviewForm");
    const commentField = document.getElementById("comment");

    form.addEventListener("submit", function (e) {
        e.preventDefault();

        const formData = new FormData(form);

        fetch("/booksReferred/1/bookReviews", {
            method: "POST",
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => {
                if (response.status === 401) {
                    document.getElementById("loginCard").style.display = "block";
                    return;
                }
                return response.text();
            })
            .then(html => {
                if (html) {
                    const reviewList = document.getElementById("reviewList");
                    const tempDiv = document.createElement("div");
                    tempDiv.innerHTML = html.trim();
                    reviewList.prepend(tempDiv.firstChild);
                    form.reset();
                    document.getElementById("loginCard").style.display = "none";
                }
            })
            .catch(err => alert("Error: " + err));
    });

    document.getElementById("signInBtn").addEventListener("click", function () {
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;

        const loginData = new URLSearchParams();
        loginData.append("username", username);
        loginData.append("password", password);

        fetch("/login", {
            method: "POST",
            body: loginData,
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            }
        })
            .then(response => {
                if (!response.ok) throw new Error("Login failed");
                form.dispatchEvent(new Event("submit"));
            })
            .catch(err => alert("Login error: " + err.message));
    });
</script>

</body>
</html>
