<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
    <head>
        <meta charset="UTF-8">
        <title>Book Reviews</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- Bootstrap CSS CDN -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

        <style>
            .user-menu {
                position: relative;
                display: inline-block;
            }

            .user-menu-content {
                display: none;
                position: absolute;
                right: 0;
                background-color: #fff;
                min-width: 160px;
                border: 1px solid #ddd;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
                z-index: 1000;
            }

            .user-menu-content.show {
                display: block;
            }

            .user-menu-content button {
                width: 100%;
                padding: 8px 12px;
                border: none;
                background: none;
                text-align: left;
            }

            .user-menu-content button:hover {
                background-color: #f8f9fa;
            }
        </style>
    </head>
    <body class="bg-light">

        <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom mb-4 px-3">
            <a class="navbar-brand" href="#">ðŸ“š BookZone</a>
            <div class="ms-auto">
                <!-- Shown only if authenticated -->
                <div th:if="${loggedInUserName != null}" class="dropdown">
                    <a class="nav-link dropdown-toggle fw-semibold" href="#" id="userDropdown" role="button"
                       data-bs-toggle="dropdown" aria-expanded="false">
                        Hello, <span th:text="${loggedInUserName}"></span>
                    </a>
                    <div class="user-menu-content" id="userMenu">
                        <form th:action="@{/logout}" method="post">
                            <button type="submit" class="text-danger">Logout</button>
                        </form>
                    </div>
                </div>

                <div th:if="${loggedInUserName == null}">
                    <a id="loginBtn" class="btn btn-outline-primary me-2"
                       th:href="@{/login}">Login</a>
        <!--            <a class="btn btn-primary" href="/register">Sign Up</a>&ndash;&gt;-->
                </div>


            </div>
        </nav>

        <div class="container mt-5">
            <h2 th:text="${bookTitle}"></h2>

            <hr>

            <!-- Reviews -->
            <div class="mb-4">
                <h4>Reviews</h4>
                <div class="list-group" id="reviewList">
                    <!-- Dynamically inserted reviews go here -->
                    <div class="list-group">
                        <div th:each="review : ${reviews}" class="list-group-item list-group-item-action">
                            <p th:text="${review.comment}" class="mb-1"></p>
                            <small th:text="'Posted by ' + ${review.reviewer.fullName} + ' on ' + ${review.createdAtFormatted}"></small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add New Review -->
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Add a Review</h5>

                    <form id="reviewForm" th:data-bookId="${bookId}">
                        <!-- Comment -->
                        <div class="mb-3">
                            <label for="comment" class="form-label">Comment</label>
                            <textarea id="comment" name="comment" class="form-control" rows="3" required></textarea>
                        </div>

                        <!-- Submit -->
                        <button type="submit" class="btn btn-primary">Post Review</button>
                    </form>
                </div>
            </div>
        </div>

    <!-- JavaScript -->
        <script>

            function submitReview(bookId) {
                const form = document.getElementById("reviewForm");
                const commentField = document.getElementById("comment");

                form.addEventListener("submit", function (e) {
                    e.preventDefault();

                    const bookId = form.getAttribute("data-bookId");
                    const formData = new FormData(form);

                    fetch("/booksReferred/${bookId}/bookReviews", {
                        method: "POST",
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                        .then(response => {
                            if (response.status === 403) {
                                document.getElementById("loginCard").style.display = "block";
                                return;
                            }
                            return response.text();
                        })
                        .then(html => {
                            if (html) {
                                const reviewList = document.getElementById("reviewList");
                                const tempDiv = document.createElement("div");
                                tempDiv.innerHTML = html.trim();
                                reviewList.prepend(tempDiv.firstChild);
                                form.reset();
                                document.getElementById("loginCard").style.display = "none";
                            }
                        })
                        .catch(err => alert("Error: " + err));
                });
            }

            document.addEventListener("DOMContentLoaded", function () {
                const loginBtn = document.getElementById("loginBtn");
                if (loginBtn) {
                    loginBtn.addEventListener("click", function (e) {
                        e.preventDefault();
                        const currentUrl = window.location.pathname + window.location.search;
                        window.location.href = `/login?returnTo=${encodeURIComponent(currentUrl)}`;
                    });
                }
            });

            const toggleBtn = document.getElementById('userToggleBtn');
            const userMenu = document.getElementById('userMenu');

            toggleBtn.addEventListener('click', function (e) {
                e.stopPropagation();
                userMenu.classList.toggle('show');
            });

            // Hide dropdown when clicking outside
            window.addEventListener('click', function () {
                if (userMenu.classList.contains('show')) {
                    userMenu.classList.remove('show');
                }
            });

        </script>
    </body>
</html>
